<!DOCTYPE html>
<html>
	<head>
		<title>유한누리 만족도조사 페이지</title>
		<meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
		
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
		  integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z"
		  crossorigin="anonymous">
		<script src="https://code.jquery.com/jquery-3.5.1.min.js"
			integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
			crossorigin="anonymous">
		</script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
			integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
			crossorigin="anonymous">
		</script>
		<style>
			body,html{
                height: 100% !important;
				width: 100% !important;
				margin: 0 !important;
				padding: 0 !important;
            }
			
			.form-question {
				margin-top:30px;
				margin-bottom:10px;
			}
		</style>
	</head>
	<body>
	<div class="container-fluid">
		<div class="row" style="height:60px; margin-bottom:20px;">
			<div class="col align-self-center">
				<label style="font-size:180%;">만족도 조사</label>
			</div>
		</div>
		<form method="POST" id="formList">
			<div style="form align-self-center">
				<input type="hidden" value="<%=serial[0].serialno%>" name="reservationNo">
				<% for(let i=0; i<testAsk.length; i++){ %>
					<div class="form-group">
						<div class="form-group form-question">
							<label id="mentalAsk<%=i%>"><b><%= testAsk[i].ask %></b></label><br/>
							<input type="hidden" value="<%=testAsk[i].askno%>" id="mentalAskVal<%=i%>"/>
						<% if(testAsk[i].choicetypename === "Radio"){ %>
							<% for(let j=0; j<testAsk[i].choices.split('|').length; j++){ %>
							<input type="radio" class="from-input mb-4" name="mentalAskAnswer<%=i%>"
								   id="<%= 'mentalAnswer'+i+j %>" value="<%= testAsk[i].choices.split('|')[j] %>">
							<label for="<%= 'mentalAnswer'+i+j %>"><%= testAsk[i].choices.split('|')[j] %></label><br/>
							<% } %>
						<% } %>
						<% if(testAsk[i].choicetypename === "Check"){ %>
							<% for(let j=0; j<testAsk[i].choices.split('|').length; j++){ %>
							<input type="checkbox" class="from-input mb-4" name="mentalAskAnswer<%=i%>"
								   id="<%= 'mentalAnswer'+i+j %>" value="<%= testAsk[i].choices.split('|')[j] %>">
							<label for="<%= 'mentalAnswer'+i+j %>"><%= testAsk[i].choices.split('|')[j] %></label><br/>
							<% } %>
						<% } %>
						<% if(testAsk[i].choicetypename === "Normal"){ %>
							<textarea class="form-control mb-4" placeholder="자유롭게 작성해 주세요." name="mentalAskAnswer<%=i%>"
									  id="<%= 'mentalAnswer'+i %>" style="resize:none;"></textarea>
						<% } %>
						</div>
					</div>
				<% } %>
				<input type="hidden" id="Fulldata" name="Fulldata" value="">
					<input type="button" class="btn btn-primary pull-right" value="답변완료" id="btnSuccess" style="padding:.300rem .60rem;">
					<br/>
					<br/>
					<br/>
			</div>	
		</form>
	</div>
		<script>
			$("#btnSuccess").click(function(e) {
				let temp = getMentalAnswer();
				if(temp != undefined && temp != null){
					$('#Fulldata').val(JSON.stringify(temp));
					$("#formList").submit();
					alert("답변이 완료되었습니다.");
				}
			});
			
			function getMentalAnswer() {
				let dynamic = [];

				for(let i=0; i < <%= testAsk.length %>; i++) {
					let temp = {}

					let what_type = document.getElementsByName("mentalAskAnswer"+i)[0].type;
					if(what_type === 'radio') {
						let checkAnswer = $('input[name=mentalAskAnswer'+i+']:checked').val();
						if(checkAnswer != undefined) temp.answer = $('input[name=mentalAskAnswer'+i+']:checked').val();
						else {
							alert('답변하지 않은 질문이 있습니다.');
							$('input[name=mentalAskAnswer'+i+']').focus();
							dynamic.length = 0;
							return null;
						}
					}
					else if(what_type === 'checkbox') {
						let checkAnswer = [];
						$('input:checkbox[name=mentalAskAnswer'+i+']:checked').each(function() {
							checkAnswer.push($(this).val());
						});

						if(checkAnswer.length !== 0) temp.answer = checkAnswer.toString();
						else {
							alert('답변하지 않은 질문이 있습니다.');
							$('input:checkbox[name=mentalAskAnswer'+i+']').focus();
							dynamic.length = 0;
							return null;
						}
					}
					else if(what_type === 'textarea') {
						let txt = $('[name=mentalAskAnswer'+i+']').val();
						if(txt !== "") temp.answer = $('[name=mentalAskAnswer'+i+']').val();
						else {
							alert('답변하지 않은 질문이 있습니다.');
							$('[name=mentalAskAnswer'+i+']').focus();
							dynamic.length = 0;
							return null;
						}
					}
					temp.question = $('#mentalAskVal'+i).val();
					dynamic.push(temp);
				}
				return dynamic;
			}
		</script>
	</body>
</html>